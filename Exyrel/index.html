<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Chat ‚Äî Think Deep (All fixes: Settings opens first click + Images + Lna code-only + Blue links + Google images + Persistent & Weather themes + Mobile full-screen input)</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0f1115; --panel:#151822; --border:#2a2f3a;
      --text:#e6e9f0; --muted:#a7b0bf; --accent:#4f7cff; --accent-2:#20c997; --danger:#ff5c5c;
      --bubble-user:#24334b; --bubble-ai:#1b2433; --shadow:0 0 20px rgba(0,0,0,0.4);
      --bg-2:#10131a; --white:#ffffff;
      --overlay: rgba(0,0,0,0.55);
      --banner:#1a1f2e; --banner-text:#e6e9f0; --warning:#ffb020;
      --blue:#4f7cff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}

    /* Layout */
    .app{
      display:grid;
      grid-template-columns:300px 1fr;
      grid-template-rows:auto auto 1fr auto;
      grid-template-areas:
        "sidebar header"
        "sidebar quota"
        "sidebar main"
        "sidebar input";
      height:100vh;
    }

    /* Header */
    .header{grid-area:header;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--panel)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:#202636;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:var(--accent);border-color:var(--accent)}
    .btn.success{background:var(--accent-2);border-color:var(--accent-2)}
    .btn.danger{background:var(--danger);border-color:var(--danger)}
    .toggle-sidebar{display:none}

    /* Sidebar */
    .sidebar{grid-area:sidebar;border-right:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;min-width:220px;z-index:20}
    .sidebar .top{padding:12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .list{flex:1;overflow-y:auto;padding:8px}
    .history-item{padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:#1a1f2e;cursor:pointer}
    .history-item:hover{border-color:var(--accent)}
    .history-item .title{font-weight:700;margin-bottom:4px;color:var(--white)}
    .history-item .meta{color:var(--muted);font-size:12px}
    .sidebar .footer{padding:10px;border-top:1px solid var(--border);display:flex;gap:8px}

    /* Quota banner */
    .quota{grid-area:quota;display:none;align-items:center;gap:10px;padding:10px 16px;background:var(--banner);color:var(--banner-text);border-bottom:1px solid var(--border)}
    .quota.show{display:flex}
    .quota .warn{color:var(--warning);font-weight:800}
    .quota .count{font-weight:700}
    .quota .small{color:var(--muted);font-size:12px;margin-left:auto}

    /* Main */
    .main{grid-area:main;position:relative;display:flex;overflow:hidden}
    .messages{
      flex:1;overflow-y:auto;padding:16px;scroll-behavior:smooth;
      background:var(--bg-2);
      background-size:cover;background-position:center;background-repeat:no-repeat;
      transition: background-image 600ms ease-out;
    }
    .msg{max-width:72%;padding:10px 12px;border-radius:12px;margin:6px 0;border:1px solid var(--border);white-space:pre-wrap;word-wrap:break-word;color:var(--white)}
    .msg.user{margin-left:auto;background:var(--bubble-user)}
    .msg.ai{margin-right:auto;background:var(--bubble-ai)}
    .msg .role{color:var(--muted);font-size:12px;margin-bottom:6px}
    .msg .images{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .msg .images img{max-width:260px;max-height:260px;border-radius:8px;border:1px solid var(--border);background:#0c0f16}
    .msg a{color:var(--blue);text-decoration:underline}

    /* Lna code-only view */
    .lna-wrap{background:#0d1117;border:1px solid #263042;border-radius:10px;padding:8px;margin:6px 0}
    .lna-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .lna-lang{font-weight:700;color:#9aa3b2}
    .copy-btn{background:#18202c;border:1px solid #2b3646;color:#e6e9f0;border-radius:8px;padding:6px 10px;cursor:pointer}
    pre{margin:0;overflow:auto}
    code{color:#cfe1ff;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;line-height:1.5}

    /* Input: Desktop+Mobile unified */
    .input{
      grid-area:input;display:flex;gap:8px;padding:10px;border-top:1px solid var(--border);
      background:var(--panel);align-items:center;
    }
    .composer{flex:1;display:flex;gap:8px;align-items:center}

    .input-bar{display:flex;align-items:center;gap:10px;width:100%}
    .circle-btn{
      width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:#202636;border:1px solid var(--border);color:var(--text);cursor:pointer;flex-shrink:0;
    }
    .circle-btn:hover{border-color:var(--accent)}
    .send-btn{background:var(--accent);border-color:var(--accent)}
    .image-btn{background:#202636}
    .input-text{
      flex:1;border:1px solid var(--border);background:#12151f;color:var(--text);
      border-radius:22px;padding:10px 14px;min-height:44px;outline:none;resize:none;
    }

    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .thumb{position:relative}
    .thumb img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .thumb .x{position:absolute;top:2px;right:2px;background:#0008;border:1px solid var(--border);color:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-size:12px}

    /* Settings modal (reliable open first click) */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.6);
      display:none;align-items:center;justify-content:center;z-index:1000;
      opacity:0;transition:opacity 160ms ease;
    }
    .modal-backdrop.show{display:flex;opacity:1}
    .modal{
      width:96vw;max-width:980px;height:82vh;background:#0b0b0b;color:#e6e9f0;
      border:1px solid #222;border-radius:16px;overflow:hidden;display:flex;flex-direction:column
    }
    .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #222;background:#0f0f0f}
    .modal .body{flex:1;padding:16px;display:grid;gap:16px;grid-template-columns:1fr 1fr;overflow:auto}
    .modal .row{display:flex;flex-direction:column;background:#101010;border:1px solid #222;border-radius:12px;padding:12px}
    .modal .row .desc{color:var(--muted);font-size:12px;margin-top:6px}
    .modal input,.modal select,.modal textarea{width:100%;padding:10px;border:1px solid #333;border-radius:8px;background:#111;color:#e6e9f0;margin-top:4px}
    .modal .foot{padding:12px 16px;border-top:1px solid #222;display:flex;justify-content:flex-end;background:#0f0f0f;gap:8px}
    .section-title{grid-column:1/-1;font-weight:800;color:#cfe1ff;background:transparent;padding:0;border:none}
    .section-divider{grid-column:1/-1;border:0;border-top:1px solid #222;margin:0}

    /* Login popup (re-openable) */
    .login-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:900}
    .login-backdrop.show{display:flex}
    .login-dialog{width:96vw;max-width:460px;background:#0b0b0b;border:1px solid #222;border-radius:16px;box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:12px}
    .login-head{display:flex;justify-content:space-between;align-items:center}
    .login-title{font-weight:800}
    .login-body{display:flex;flex-direction:column;gap:12px}
    .login-foot{display:flex;justify-content:flex-end;gap:8px}
    .note{color:var(--muted);font-size:12px}

    /* Mobile + off-canvas sidebar */
    .mobile-overlay{position:fixed;inset:0;background:var(--overlay);display:none;z-index:25}
    .mobile-overlay.show{display:block}
    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:"header""quota""main""input";
        height:100vh;
      }
      .toggle-sidebar{display:inline-flex}
      .header,.quota,.main,.input{width:100vw}
      .main{height:calc(100vh - 180px)}
      .messages{padding:12px}
      .sidebar{
        position:fixed;top:0;right:0;bottom:0;
        width:85vw;max-width:360px;min-width:auto;
        transform:translateX(100%);
        transition:transform 280ms ease;
        border-left:1px solid var(--border);border-right:none;
        display:flex;z-index:26;
      }
      .sidebar.show{transform:translateX(0)}
      .modal{width:100vw;height:100vh;border-radius:0}
      .input{position:sticky;bottom:0;left:0;right:0;padding:12px 12px 16px}
      .input-text{min-height:48px;border-radius:24px}
      .circle-btn{width:48px;height:48px}
    }
    @media (max-width:600px){
      .msg{max-width:100%}
      .input{padding:12px}
      .input-text{min-height:52px;border-radius:26px}
      .circle-btn{width:52px;height:52px}
      .main{height:calc(100vh - 190px)}
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="app" id="app" aria-live="polite">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" aria-label="‡πÅ‡∏ñ‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">
    <div class="top">
      <div id="ui_sidebar_options" style="font-weight:700">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      <button id="btnNewChat" class="btn success">‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div class="list" id="historyList"></div>
    <div class="footer">
      <button id="btnExport" class="btn">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
      <button id="btnClearHistory" class="btn danger">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </aside>
  <div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>

  <!-- Header -->
  <header class="header">
    <div class="brand">
      <div class="dot" aria-hidden="true"></div>
      <div id="ui_title">AI Chat ‚Äî Think Deep</div>
      <small class="toggle-sidebar" style="color:var(--muted)" id="ui_toggle_hint">‚Ä¢ ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÅ‡∏ñ‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‚Äù</small>
    </div>
    <div class="actions">
      <button id="btnToggleSidebar" class="btn toggle-sidebar">‡πÅ‡∏ñ‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      <button id="btnSettings" class="btn">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      <div id="loginContainer">
        <button id="btnGoogleLogin" class="btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google (‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏¢)</button>
      </div>
      <div id="profileContainer" class="profile-menu" style="display:none">
        <div id="btnProfile" class="profile">
          <img id="profileAvatar" src="" alt="avatar">
          <span id="profileName" class="profile-name">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
        </div>
        <div id="profileDropdown" class="profile-dropdown">
          <div class="item" id="btnSyncNow">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
          <div class="item danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Quota banner -->
  <div class="quota" id="quotaBanner">
    <span class="warn" id="ui_quota_reached">‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á API Key</span>
    <span id="ui_quota_text">‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô</span>
    <span class="count" id="quotaCountdown">00:00:00</span>
    <span class="small" id="quotaReason"></span>
  </div>

  <!-- Main -->
  <main class="main">
    <div class="messages" id="messages"></div>
  </main>

  <!-- Input -->
  <footer class="input" id="footerText">
    <div class="composer input-bar">
      <button id="btnPickImage" class="circle-btn image-btn" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">üì∑</button>
      <textarea id="inputText" class="input-text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ) ‚Äî ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ"></textarea>
      <button id="btnSend" class="circle-btn send-btn" title="‡∏™‡πà‡∏á">‚û§</button>
      <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
    </div>
  </footer>
  <div class="thumbs" id="thumbs" style="padding:0 12px 10px 12px;"></div>
</div>

<!-- Settings Modal (bug-fixed: opens reliably on first click) -->
<div class="modal-backdrop" id="settingsBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="head">
      <div style="font-weight:800" id="ui_settings_title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI, Themes, Google ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤</div>
      <button id="btnCloseSettings" class="btn">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="body">
      <div class="section-title" id="ui_settings_chat_title">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û</div>
      <div class="row"><label for="providerEndpoint">Chat endpoint URL</label><input id="providerEndpoint" placeholder="https://api.openai.com/v1/chat/completions"></div>
      <div class="row"><label for="apiKey">API Key</label><input id="apiKey" type="password" placeholder="‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"><div class="desc">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div></div>
      <div class="row"><label for="model">Chat model</label><input id="model" placeholder="‡πÄ‡∏ä‡πà‡∏ô gpt-4o ‡∏´‡∏£‡∏∑‡∏≠ gpt-4o-mini"></div>
      <div class="row"><label for="systemPrompt">System prompt</label><textarea id="systemPrompt" rows="3" placeholder="‡∏õ‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å/‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á AI (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Lna ‡πÇ‡∏Ñ‡πâ‡∏î-only, ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°, ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏û)"></textarea></div>
      <div class="row"><label for="extraHeaders">Extra headers (JSON)</label><textarea id="extraHeaders" rows="3" placeholder="{}"></textarea></div>
      <div class="row"><label for="temperature">Chat temperature</label><input id="temperature" type="number" step="0.1" min="0" max="2" placeholder="0.7"></div>
      <div class="row"><label for="maxTokens">Chat max tokens</label><input id="maxTokens" type="number" step="1" min="1" placeholder="2048"></div>
      <div class="row"><label for="timeoutMs">Timeout (ms)</label><input id="timeoutMs" type="number" step="100" min="1000" placeholder="150000"></div>

      <hr class="section-divider">
      <div class="section-title">Lna ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î-only</div>
      <div class="row">
        <label for="lnaEnabled">‡πÄ‡∏õ‡∏¥‡∏î Lna code-only responses</label>
        <select id="lnaEnabled">
          <option value="off">‡∏õ‡∏¥‡∏î</option>
          <option value="on">‡πÄ‡∏õ‡∏¥‡∏î</option>
        </select>
        <div class="desc">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î ‡∏´‡∏≤‡∏Å AI ‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï Lna ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      </div>

      <hr class="section-divider">
      <div class="section-title">‡∏ò‡∏µ‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£)</div>
      <div class="row"><label for="themeImageDataUrl">Theme image Data URL</label><textarea id="themeImageDataUrl" rows="3" placeholder="‡∏ß‡∏≤‡∏á data:image/... ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á"></textarea><div class="desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏•‡∏á local storage</div></div>

      <hr class="section-divider">
      <div class="section-title">‡∏ò‡∏µ‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å Google</div>
      <div class="row"><label for="googleApiKey">Google API Key</label><input id="googleApiKey" type="password" placeholder="‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Custom Search"></div>
      <div class="row"><label for="googleCx">Google CSE ID (cx)</label><input id="googleCx" placeholder="‡∏£‡∏´‡∏±‡∏™ Custom Search Engine (cx)"></div>
      <div class="row"><label for="googleSafe">SafeSearch</label><select id="googleSafe"><option value="off">off</option><option value="medium">medium</option><option value="high">high</option></select></div>
      <div class="row"><label for="enableRandomWeatherTheme">‡πÄ‡∏õ‡∏¥‡∏î‡∏ò‡∏µ‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏™‡∏∏‡πà‡∏°</label><select id="enableRandomWeatherTheme"><option value="off">‡∏õ‡∏¥‡∏î</option><option value="on">‡πÄ‡∏õ‡∏¥‡∏î</option></select></div>
      <div class="row"><label for="weatherRefreshMinutes">‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input id="weatherRefreshMinutes" type="number" min="1" step="1" placeholder="30"></div>

      <hr class="section-divider">
      <div class="section-title" id="ui_google_title">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Login & Drive Sync</div>
      <div class="row"><label for="googleClientId">Google Client ID</label><input id="googleClientId" placeholder="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"></div>

      <hr class="section-divider">
      <div class="section-title" id="ui_lang_title">‡∏†‡∏≤‡∏©‡∏≤ UI</div>
      <div class="row"><label for="uiLanguage">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤</label>
        <select id="uiLanguage">
          <option value="th">‡πÑ‡∏ó‡∏¢</option>
          <option value="en">English</option>
        </select>
      </div>

      <hr class="section-divider">
      <div class="section-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î API</div>
      <div class="row"><label for="quotaDefaultSeconds">‡πÄ‡∏ß‡∏•‡∏≤ Countdown ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label><input id="quotaDefaultSeconds" type="number" min="30" step="30" placeholder="3600"></div>
      <div class="row"><label for="quotaHint">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label><input id="quotaHint" placeholder="‡πÄ‡∏ä‡πà‡∏ô 'Rate limit / Insufficient quota'"></div>
    </div>
    <div class="foot">
      <button id="btnResetSettings" class="btn danger">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      <button id="btnTest" class="btn">‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</button>
      <button id="btnSaveSettings" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Login popup (re-openable) -->
<div id="loginBackdrop" class="login-backdrop" aria-hidden="true">
  <div class="login-dialog" role="dialog" aria-modal="true" aria-label="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google">
    <div class="login-head">
      <div class="login-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google</div>
      <button id="btnCloseLogin" class="btn">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="login-body">
      <div class="note">‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏õ‡∏∏‡πà‡∏° Google ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ö‡∏±‡∏Ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î</div>
      <div id="googleButtonWrapper" style="display:flex;justify-content:center"></div>
      <div style="display:flex;justify-content:center;gap:8px">
        <button id="btnGrantDrive" class="btn">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive (AppData)</button>
        <button id="btnRestoreCloud" class="btn">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud</button>
      </div>
    </div>
    <div class="login-foot">
      <button id="btnLoginDone" class="btn primary">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
    </div>
  </div>
</div>

<script>
/* ========= Storage & Defaults ========= */
const LS_KEYS = {
  settings:"ai.settings.allfix.v2",
  historyIndex:"ai.history.index.allfix.v2",
  chatsPrefix:"ai.chat.",
  auth:"ai.auth.google.state.v1",
  driveFileId:"ai.drive.file.id.v1",
};
const defaultSettings = {
  providerEndpoint:"https://api.openai.com/v1/chat/completions",
  apiKey:"",
  model:"gpt-4o-mini",
  systemPrompt:"You are a precise, emotionally intelligent Thai assistant. Rules: 1) Blue clickable links for any URLs. 2) If the user sends text with images, infer the intended meaning of the words first (concise, faithful), then integrate relevant visual details. 3) Lna code-only mode: when the user requests code or code is the best answer, output using Lna wrapper and fenced blocks; UI will render code-only. 4) Avoid repetition and never restate the same conclusion multiple times. 5) Keep responses tight, structured, and useful.",
  extraHeaders:{},
  temperature:0.7,
  maxTokens:2048,
  timeoutMs:150000,

  /* Themes (persistent) */
  themeImageDataUrl:"",
  enableRandomWeatherTheme:"off",
  googleApiKey:"",
  googleCx:"",
  googleSafe:"off",
  weatherRefreshMinutes:30,

  /* Lna */
  lnaEnabled:"on",

  /* Google */
  googleClientId:"",

  /* I18n */
  uiLanguage:"th",

  /* Quota */
  quotaDefaultSeconds: 3600,
  quotaHint: "Rate limit / Insufficient quota",
};
function loadSettings(){ try{ const raw=localStorage.getItem(LS_KEYS.settings); if(!raw) return {...defaultSettings}; const parsed=JSON.parse(raw); return {...defaultSettings, ...(parsed||{})}; }catch(e){ return {...defaultSettings}; } }
function saveSettings(s){ try{ localStorage.setItem(LS_KEYS.settings, JSON.stringify(s||defaultSettings)); }catch(e){ alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ: "+(e?.message||e)); } }
function uid(){ return "id_"+Math.random().toString(36).slice(2)+Date.now(); }
function nowISO(){ return new Date().toISOString(); }
function chatKey(chatId){ return LS_KEYS.chatsPrefix+(chatId||"unknown"); }
function loadHistoryIndex(){ try{ const raw=localStorage.getItem(LS_KEYS.historyIndex); if(!raw) return []; const parsed=JSON.parse(raw); return Array.isArray(parsed)?parsed:[]; }catch(e){ return []; } }
function saveHistoryIndex(idx){ try{ localStorage.setItem(LS_KEYS.historyIndex, JSON.stringify(idx||[])); }catch(e){ alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e)); } }
function loadChat(chatId){ try{ if(!chatId) return null; const raw=localStorage.getItem(chatKey(chatId)); if(!raw) return null; const parsed=JSON.parse(raw); return (parsed && Array.isArray(parsed.messages)) ? parsed : null; }catch(e){ return null; } }
function saveChat(chatId,chat){ try{ if(!chatId||!chat) return; localStorage.setItem(chatKey(chatId), JSON.stringify(chat)); scheduleSync(); }catch(e){ alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ä‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e)); } }
function escapeHtml(str){ if(str==null) return ""; return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function safeJsonStringify(obj){ try{ return JSON.stringify(obj||{}, null, 2); }catch(e){ return "{}"; } }

/* ========= I18n ========= */
const I18N = {
  th: { title:"AI Chat ‚Äî Think Deep", sidebarOptions:"‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", toggleHistory:"‡πÅ‡∏ñ‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", settings:"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", loginGoogle:"‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google (‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏¢)",
    settingsTitle:"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI, Themes, Google ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤", settingsChatTitle:"‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û",
    quotaTitle:"‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î API", quotaReached:"‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á API Key", quotaText:"‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô",
    googleTitle:"‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Login & Drive Sync", langTitle:"‡∏†‡∏≤‡∏©‡∏≤ UI",
    imagesTitle:"‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", imagesHint:"‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå/‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î", deepThink:"‡∏Ñ‡∏¥‡∏î‡∏ô‡∏≤‡∏ô (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏∂‡∏Å)", send:"‡∏™‡πà‡∏á",
    reset:"‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï", test:"‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)", save:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
  },
  en: { title:"AI Chat ‚Äî Think Deep", sidebarOptions:"Options", toggleHistory:"History", settings:"Settings", loginGoogle:"Google Login (Popup)",
    settingsTitle:"Configure AI, Themes, Google, and Language", settingsChatTitle:"Text & Vision Chat Settings",
    quotaTitle:"API Quota Management", quotaReached:"API key limit reached", quotaText:"You can send again in",
    googleTitle:"Google Login & Drive Sync Settings", langTitle:"UI Language",
    imagesTitle:"Images for AI analysis", imagesHint:"Drag & drop / select files / paste from clipboard", deepThink:"Deep think (analysis)", send:"Send",
    reset:"Reset", test:"Test (chat)", save:"Save"
  }
};
function applyI18n(){
  const dict = I18N[state.settings.uiLanguage] || I18N.th;
  document.getElementById("ui_title").textContent = dict.title;
  document.getElementById("ui_sidebar_options").textContent = dict.sidebarOptions;
  document.getElementById("btnToggleSidebar").textContent = dict.toggleHistory;
  document.getElementById("btnSettings").textContent = dict.settings;
  document.getElementById("btnGoogleLogin").textContent = dict.loginGoogle;
  document.getElementById("ui_settings_title").textContent = dict.settingsTitle;
  document.getElementById("ui_settings_chat_title").textContent = dict.settingsChatTitle;
  document.getElementById("ui_quota_reached").textContent = dict.quotaReached;
  document.getElementById("ui_quota_text").textContent = dict.quotaText;
}

/* ========= State ========= */
const state = {
  settings: loadSettings(),
  historyIndex: loadHistoryIndex(),
  currentChatId: null,
  isSending: false,
  deepThink: true,
  pendingImages: [],
  quotaUntil: null,
  quotaTimer: null,
  weatherTimer: null,
  /* Auth */
  auth: loadAuth(),
  driveFileId: loadDriveFileId(),
  syncScheduled: false,
  /* UI */
  googleButtonRendered: false,
  /* Guards */
  settingsOpenLock: false,
};

/* ========= Auth ========= */
function loadAuth(){ try{ const raw=localStorage.getItem(LS_KEYS.auth); return raw?JSON.parse(raw):{ user:null, idToken:null, accessToken:null, accessTokenExp:0 }; }catch(e){ return { user:null, idToken:null, accessToken:null, accessTokenExp:0 }; } }
function saveAuth(a){ try{ localStorage.setItem(LS_KEYS.auth, JSON.stringify(a||{ user:null })); }catch(e){} }
function loadDriveFileId(){ try{ const raw=localStorage.getItem(LS_KEYS.driveFileId); return raw||null; }catch(e){ return null; } }
function saveDriveFileId(id){ try{ if(id) localStorage.setItem(LS_KEYS.driveFileId, id); }catch(e){} }

/* ========= DOM ========= */
const el = {
  sidebar: document.getElementById("sidebar"),
  mobileOverlay: document.getElementById("mobileOverlay"),
  historyList: document.getElementById("historyList"),

  btnNewChat: document.getElementById("btnNewChat"),
  btnExport: document.getElementById("btnExport"),
  btnClearHistory: document.getElementById("btnClearHistory"),
  btnToggleSidebar: document.getElementById("btnToggleSidebar"),
  btnSettings: document.getElementById("btnSettings"),

  messages: document.getElementById("messages"),
  inputText: document.getElementById("inputText"),
  btnSend: document.getElementById("btnSend"),
  btnPickImage: document.getElementById("btnPickImage"),
  fileInput: document.getElementById("fileInput"),
  thumbs: document.getElementById("thumbs"),

  quotaBanner: document.getElementById("quotaBanner"),
  quotaCountdown: document.getElementById("quotaCountdown"),
  quotaReason: document.getElementById("quotaReason"),

  /* Settings */
  settingsBackdrop: document.getElementById("settingsBackdrop"),
  btnCloseSettings: document.getElementById("btnCloseSettings"),
  btnSaveSettings: document.getElementById("btnSaveSettings"),
  btnResetSettings: document.getElementById("btnResetSettings"),
  btnTest: document.getElementById("btnTest"),
  providerEndpoint: document.getElementById("providerEndpoint"),
  apiKey: document.getElementById("apiKey"),
  model: document.getElementById("model"),
  systemPrompt: document.getElementById("systemPrompt"),
  extraHeaders: document.getElementById("extraHeaders"),
  temperature: document.getElementById("temperature"),
  maxTokens: document.getElementById("maxTokens"),
  timeoutMs: document.getElementById("timeoutMs"),
  themeImageDataUrl: document.getElementById("themeImageDataUrl"),
  googleApiKey: document.getElementById("googleApiKey"),
  googleCx: document.getElementById("googleCx"),
  googleSafe: document.getElementById("googleSafe"),
  enableRandomWeatherTheme: document.getElementById("enableRandomWeatherTheme"),
  weatherRefreshMinutes: document.getElementById("weatherRefreshMinutes"),
  lnaEnabled: document.getElementById("lnaEnabled"),
  googleClientId: document.getElementById("googleClientId"),
  uiLanguage: document.getElementById("uiLanguage"),

  /* Login/Profile */
  loginContainer: document.getElementById("loginContainer"),
  btnGoogleLogin: document.getElementById("btnGoogleLogin"),
  profileContainer: document.getElementById("profileContainer"),
  btnProfile: document.getElementById("btnProfile"),
  profileDropdown: document.getElementById("profileDropdown"),
  profileAvatar: document.getElementById("profileAvatar"),
  profileName: document.getElementById("profileName"),
  btnLogout: document.getElementById("btnLogout"),
  btnSyncNow: document.getElementById("btnSyncNow"),

  /* Login modal */
  loginBackdrop: document.getElementById("loginBackdrop"),
  googleButtonWrapper: document.getElementById("googleButtonWrapper"),
  btnCloseLogin: document.getElementById("btnCloseLogin"),
  btnLoginDone: document.getElementById("btnLoginDone"),
  btnGrantDrive: document.getElementById("btnGrantDrive"),
  btnRestoreCloud: document.getElementById("btnRestoreCloud"),
};

/* ========= Theme ========= */
function applyThemeBackground(dataUrl){
  try{ el.messages.style.backgroundImage = dataUrl ? `url('${dataUrl}')` : ""; }catch(e){}
}

/* ========= Quota ========= */
function showQuotaCountdown(seconds, reason){
  const until = new Date(Date.now() + Math.max(1, seconds)*1000);
  state.quotaUntil = until;
  el.quotaReason.textContent = reason || state.settings.quotaHint || "";
  el.quotaBanner.classList.add("show");
  tickQuota();
  if(state.quotaTimer) clearInterval(state.quotaTimer);
  state.quotaTimer = setInterval(tickQuota, 1000);
}
function tickQuota(){
  if(!state.quotaUntil){
    el.quotaBanner.classList.remove("show");
    if(state.quotaTimer) clearInterval(state.quotaTimer);
    return;
  }
  const diffMs = state.quotaUntil.getTime() - Date.now();
  if(diffMs <= 0){
    el.quotaCountdown.textContent = "00:00:00";
    el.quotaBanner.classList.remove("show");
    clearInterval(state.quotaTimer); state.quotaTimer=null; state.quotaUntil=null;
    return;
  }
  const h = Math.floor(diffMs/3600000);
  const m = Math.floor((diffMs%3600000)/60000);
  const s = Math.floor((diffMs%60000)/1000);
  el.quotaCountdown.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* ========= Utility: linkify to blue links ========= */
function linkifyHtml(escapedText){
  const urlRegex = /\b(https?:\/\/[^\s<]+[^\s<\.)])/gi;
  return escapedText.replace(urlRegex, (match)=>{
    const href = escapeHtml(match);
    return `<a href="${href}" target="_blank" rel="noopener">${href}</a>`;
  });
}

/* ========= Lna parser (code-only) =========
   Expected format inside assistant content:
   <<<Lna:lang=javascript>>>
   // code...
   <<<Lna:end>>>
*/
function extractLnaBlocks(text){
  const blocks=[];
  const re = /<<<Lna:lang=([\w\-]+)>>>[\s\S]*?<<<Lna:end>>>/g;
  let m;
  while((m = re.exec(text))){
    const full = m[0];
    const lang = (m[1]||"text").trim();
    const inner = full.replace(/<<<Lna:lang=[\w\-]+>>>/, "").replace(/<<<Lna:end>>>/, "").trim();
    blocks.push({ lang, code: inner });
  }
  return blocks;
}
function renderLnaBlock(lang, code){
  const wrap=document.createElement("div"); wrap.className="lna-wrap";
  const head=document.createElement("div"); head.className="lna-head";
  const langEl=document.createElement("div"); langEl.className="lna-lang"; langEl.textContent=(lang||"").toUpperCase();
  const btn=document.createElement("button"); btn.className="copy-btn"; btn.textContent="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î";
  btn.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(code); btn.textContent="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"; setTimeout(()=>btn.textContent="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î", 1200); }catch{ btn.textContent="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; setTimeout(()=>btn.textContent="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î", 1200); }
  });
  head.appendChild(langEl); head.appendChild(btn);
  const pre=document.createElement("pre"); const codeEl=document.createElement("code");
  codeEl.textContent=code; pre.appendChild(codeEl);
  wrap.appendChild(head); wrap.appendChild(pre);
  return wrap;
}

/* ========= Renderers ========= */
function renderHistoryIndex(){
  try{
    el.historyList.innerHTML="";
    const idx=state.historyIndex.slice().sort((a,b)=> new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt));
    for(const item of idx){
      const div=document.createElement("div");
      div.className="history-item"; div.dataset.id=item.id;
      const title=item.title||"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)";
      div.innerHTML=`<div class="title">${escapeHtml(title)}</div><div class="meta">${new Date(item.updatedAt||item.createdAt).toLocaleString()}</div>`;
      div.addEventListener("click",()=> {
        loadChatToUI(item.id);
        closeMobileSidebar();
      });
      el.historyList.appendChild(div);
    }
  }catch(e){}
}
function renderMessages(messages){
  try{
    el.messages.innerHTML="";
    const list = Array.isArray(messages)?messages:[];
    for(const m of list){
      const bubble=document.createElement("div");
      bubble.className="msg "+(m.role==="user"?"user":"ai");

      const roleLabel=m.role==="user"?"‡∏Ñ‡∏∏‡∏ì":"AI";

      if(m.role==="assistant" && state.settings.lnaEnabled==="on"){
        const lnaBlocks = extractLnaBlocks(m.content||"");
        if(lnaBlocks.length){
          bubble.innerHTML=`<div class="role">${roleLabel}</div>`;
          for(const blk of lnaBlocks){ bubble.appendChild(renderLnaBlock(blk.lang, blk.code)); }
          const imgs=Array.isArray(m.images)?m.images:[];
          if(imgs.length){
            const imgsHtml = imgs.map(img => `<img src="${img.dataUrl}" alt="${escapeHtml(img.name||"image")}" loading="lazy">`).join("");
            bubble.innerHTML += `<div class="images">${imgsHtml}</div>`;
          }
          el.messages.appendChild(bubble);
          continue;
        }
      }

      let textHtml = (m.role==="assistant")
        ? linkifyHtml(escapeHtml(m.content||""))
        : `<span>${escapeHtml(m.content||"")}</span>`;

      let html=`<div class="role">${roleLabel}</div><div>${textHtml}</div>`;

      const imgs=Array.isArray(m.images)?m.images:[];
      if(imgs.length){
        const imgsHtml = imgs.map(img => `<img src="${img.dataUrl}" alt="${escapeHtml(img.name||"image")}" loading="lazy">`).join("");
        html += `<div class="images">${imgsHtml}</div>`;
      }

      bubble.innerHTML=html;
      el.messages.appendChild(bubble);
    }
    el.messages.scrollTop=el.messages.scrollHeight;
  }catch(e){}
}

/* ========= Chat management ========= */
function newChat(initialTitle){
  const id=uid();
  const baseTitle = (initialTitle||"‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà").trim();
  const title=baseTitle ? baseTitle.slice(0,60)+(baseTitle.length>60?"...":"") : "‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà";
  const chat={id,title,messages:[],createdAt:nowISO(),updatedAt:nowISO()};
  state.currentChatId=id;
  state.historyIndex.push({id,title,createdAt:chat.createdAt,updatedAt:chat.updatedAt});
  saveHistoryIndex(state.historyIndex); saveChat(id,chat);
  renderHistoryIndex(); renderMessages(chat.messages);
  scheduleSync();
  return chat;
}
function appendMessageTo(chatId, role, content, images){
  const chat=loadChat(chatId); if(!chat) return;
  chat.messages.push({role, content: String(content||""), images: Array.isArray(images)?images:[], ts: nowISO()});
  const firstUser = chat.messages.find(m=>m.role==="user" && (m.content||"").trim().length>0);
  if(firstUser){
    const t = firstUser.content.trim().replace(/\s+/g," ").slice(0,60);
    chat.title = t || chat.title || "‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà";
  }
  chat.updatedAt=nowISO(); saveChat(chatId,chat);
  const idxItem=state.historyIndex.find(x=>x.id===chatId);
  if(idxItem){ idxItem.title=chat.title; idxItem.updatedAt=chat.updatedAt; saveHistoryIndex(state.historyIndex); }
  if(chatId===state.currentChatId) renderMessages(chat.messages);
}
function loadChatToUI(chatId){
  const chat=loadChat(chatId);
  if(!chat){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢"); return; }
  state.currentChatId=chatId; renderMessages(chat.messages);
}

/* ========= Image Handling ========= */
function addFiles(files){
  const list = Array.from(files||[]);
  if(!list.length) return;
  const tasks = list.map(file => readFileAsDataURL(file));
  Promise.all(tasks).then(imgs=>{
    for(const img of imgs){
      if(!state.pendingImages.some(x=>x.dataUrl===img.dataUrl)){ state.pendingImages.push(img); }
    }
    renderThumbs();
  }).catch(e=> alert("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e)));
}
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onerror=()=>reject(new Error("‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"));
    fr.onload=()=> resolve({ name:file.name, type:file.type, dataUrl:fr.result, width:0, height:0 });
    fr.readAsDataURL(file);
  });
}
function renderThumbs(){
  try{
    el.thumbs.innerHTML="";
    state.pendingImages.forEach((img,idx)=>{
      const d=document.createElement("div"); d.className="thumb";
      d.innerHTML=`<img src="${img.dataUrl}" alt="${escapeHtml(img.name||"image")}"><div class="x" title="‡∏•‡∏ö" data-idx="${idx}">x</div>`;
      d.querySelector(".x").addEventListener("click",()=>{ state.pendingImages.splice(idx,1); renderThumbs(); });
      el.thumbs.appendChild(d);
    });
  }catch(e){}
}

/* ========= Settings Modal (fully reliable) ========= */
function openSettings(){
  if(state.settingsOpenLock) return; // prevent re-entry
  state.settingsOpenLock = true;

  // Ensure elements exist (defensive)
  if(!el.settingsBackdrop){ alert("UI ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"); state.settingsOpenLock=false; return; }

  // Load latest settings every time
  state.settings = loadSettings();
  const s = state.settings;

  // Map fields
  el.providerEndpoint && (el.providerEndpoint.value=s.providerEndpoint||"");
  el.apiKey && (el.apiKey.value=s.apiKey||"");
  el.model && (el.model.value=s.model||"");
  el.systemPrompt && (el.systemPrompt.value=s.systemPrompt||"");
  el.extraHeaders && (el.extraHeaders.value=safeJsonStringify(s.extraHeaders||{}));
  el.temperature && (el.temperature.value=s.temperature??0.7);
  el.maxTokens && (el.maxTokens.value=s.maxTokens??2048);
  el.timeoutMs && (el.timeoutMs.value=s.timeoutMs??150000);

  el.themeImageDataUrl && (el.themeImageDataUrl.value=s.themeImageDataUrl||"");
  el.googleApiKey && (el.googleApiKey.value=s.googleApiKey||"");
  el.googleCx && (el.googleCx.value=s.googleCx||"");
  el.googleSafe && (el.googleSafe.value=s.googleSafe||"off");
  el.enableRandomWeatherTheme && (el.enableRandomWeatherTheme.value=s.enableRandomWeatherTheme||"off");
  el.weatherRefreshMinutes && (el.weatherRefreshMinutes.value=s.weatherRefreshMinutes??30);

  el.lnaEnabled && (el.lnaEnabled.value=s.lnaEnabled||"on");
  el.googleClientId && (el.googleClientId.value=s.googleClientId||"");
  el.uiLanguage && (el.uiLanguage.value=s.uiLanguage||"th");

  el.quotaDefaultSeconds && (el.quotaDefaultSeconds.value = s.quotaDefaultSeconds ?? 3600);
  el.quotaHint && (el.quotaHint.value = s.quotaHint || "");

  // Make sure modal shows on first click
  el.settingsBackdrop.style.display = "flex";
  // Force reflow then add show for transition reliability
  void el.settingsBackdrop.offsetHeight;
  el.settingsBackdrop.classList.add("show");
  el.settingsBackdrop.setAttribute("aria-hidden","false");

  // Release lock a moment after opening to avoid double open race
  setTimeout(()=>{ state.settingsOpenLock=false; }, 120);
}
function closeSettings(){
  if(!el.settingsBackdrop) return;
  el.settingsBackdrop.classList.remove("show");
  el.settingsBackdrop.setAttribute("aria-hidden","true");
  // Delay display:none to allow transition to finish
  setTimeout(()=>{ el.settingsBackdrop.style.display = "none"; }, 160);
}
function parseObj(str){ try{ const t=(str||"").trim(); if(!t) return {}; const p=JSON.parse(t); return p&&typeof p==="object"?p:{}; }catch(e){ alert("‡∏Ñ‡πà‡∏≤ JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return {}; } }
function saveSettingsFromModal(){
  const s={
    providerEndpoint:(el.providerEndpoint?.value||"").trim(),
    apiKey:(el.apiKey?.value||"").trim(),
    model:(el.model?.value||"").trim(),
    systemPrompt:(el.systemPrompt?.value||"").trim(),
    extraHeaders:parseObj(el.extraHeaders?.value||"{}"),
    temperature:Number(el.temperature?.value||defaultSettings.temperature),
    maxTokens:Number(el.maxTokens?.value||defaultSettings.maxTokens),
    timeoutMs:Number(el.timeoutMs?.value||defaultSettings.timeoutMs),

    themeImageDataUrl:(el.themeImageDataUrl?.value||"").trim(),

    googleApiKey:(el.googleApiKey?.value||"").trim(),
    googleCx:(el.googleCx?.value||"").trim(),
    googleSafe:el.googleSafe?.value||"off",
    enableRandomWeatherTheme: el.enableRandomWeatherTheme?.value||"off",
    weatherRefreshMinutes: Number(el.weatherRefreshMinutes?.value||defaultSettings.weatherRefreshMinutes),

    lnaEnabled: el.lnaEnabled?.value || "on",
    googleClientId:(el.googleClientId?.value||"").trim(),
    uiLanguage: el.uiLanguage?.value || "th",
    quotaDefaultSeconds: Number(el.quotaDefaultSeconds?.value||defaultSettings.quotaDefaultSeconds),
    quotaHint: (el.quotaHint?.value||defaultSettings.quotaHint),
  };
  state.settings=s; saveSettings(s);
  applyI18n();
  setupThemeScheduler();
  closeSettings(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}
function resetSettings(){
  state.settings = {...defaultSettings}; saveSettings(state.settings);
  openSettings();
}

/* ========= Provider Call (Text + Vision + Lna support + Meaning-first) ========= */
async function callProviderForChat(chatMessages){
  const s=state.settings;
  if(!s.providerEndpoint) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Chat endpoint");
  if(!s.apiKey) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key");

  const controller=new AbortController();
  const deep = state.deepThink;
  const timeout = deep ? Math.max(s.timeoutMs, 160000) : (s.timeoutMs||120000);
  const to=setTimeout(()=>controller.abort(), timeout);

  const headers={
    "Content-Type":"application/json",
    "Authorization":"Bearer "+s.apiKey,
    ...Object.fromEntries(Object.entries(s.extraHeaders||{}).map(([k,v])=>[k,String(v)])),
  };

  const mapped=[];
  if(s.systemPrompt){
    mapped.push({
      role:"system",
      content: s.systemPrompt + (deep ? " Be rigorous. Enforce Lna code-only when applicable (emit code in Lna wrapper). Blue links for URLs. Meaning-first when images present. Avoid repetition." : "")
    });
  }

  const list = Array.isArray(chatMessages)?chatMessages:[];
  const lastUserIndex = [...list].map((m,i)=>({m,i})).filter(x=>x.m.role==="user").map(x=>x.i).pop();
  const hasImagesLast = typeof lastUserIndex==="number" && Array.isArray(list[lastUserIndex]?.images) && list[lastUserIndex].images.length>0;

  for(const m of list){
    if(m.role==="user"){
      const parts=[];
      if(m.content){
        if(hasImagesLast && m===list[lastUserIndex]){
          parts.push({ type:"text", text: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πâ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö\n\n‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + m.content });
        }else{
          parts.push({ type:"text", text: m.content });
        }
      }
      const imgs = Array.isArray(m.images)?m.images:[];
      for(const img of imgs){ parts.push({ type:"image_url", image_url:{ url: img.dataUrl } }); }
      mapped.push(parts.length ? { role:"user", content: parts } : { role:"user", content: m.content||"" });
    }else{
      mapped.push({ role:"assistant", content: m.content||"" });
    }
  }

  const body={ model: s.model || undefined, temperature: s.temperature, max_tokens: s.maxTokens, messages: mapped };

  let res;
  try{
    res = await fetch(s.providerEndpoint, { method:"POST", headers, body: JSON.stringify(body), signal: controller.signal });
  }catch(err){
    clearTimeout(to); throw err;
  }finally{ clearTimeout(to); }

  if(!res.ok){
    const retryAfter = parseInt(res.headers.get("Retry-After")||"0",10);
    const reasonText = await res.text().catch(()=> "");
    handleQuotaIfNeeded(res.status, retryAfter, reasonText);
    throw new Error("‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ("+res.status+"): "+reasonText);
  }
  const data = await res.json().catch(err=>{ throw new Error("JSON parse error: "+err.message); });
  const reply = data?.choices?.[0]?.message?.content ?? data?.choices?.[0]?.text ?? data?.output?.text ?? data?.reply ?? safeJsonStringify(data);
  return String(reply||"").trim();
}

/* ========= Quota handling ========= */
function handleQuotaIfNeeded(status, retryAfter, bodyText){
  const lower = String(bodyText||"").toLowerCase();
  const looksQuota = status===429 || lower.includes("rate limit") || lower.includes("insufficient quota");
  if(!looksQuota) return;
  const secs = retryAfter>0 ? retryAfter : (state.settings.quotaDefaultSeconds || 3600);
  showQuotaCountdown(secs, state.settings.quotaHint || "API limit reached");
}

/* ========= Google Images in chat ========= */
const WEATHER_QUERIES = [
  "sunny sky landscape","clear sky mountain","blue sky beach panorama",
  "golden hour valley","dramatic clouds over sea","rainy cityscape",
  "misty forest morning","snowy mountain peak","thunderstorm sky landscape",
  "autumn forest sunlight","spring meadow sky","monsoon clouds over fields"
];
async function googleImageSearch(query, num=6){
  const s=state.settings;
  if(!s.googleApiKey || !s.googleCx) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google API Key ‡∏´‡∏£‡∏∑‡∏≠ CSE ID");
  const params = new URLSearchParams({
    key: s.googleApiKey, cx: s.googleCx, q: query,
    searchType: "image", safe: s.googleSafe || "off", num: String(Math.max(1, Math.min(num, 10))),
  });
  const url = "https://www.googleapis.com/customsearch/v1?"+params.toString();
  const res = await fetch(url, { method:"GET" });
  if(!res.ok){ throw new Error("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+res.status); }
  const data = await res.json().catch(()=>null);
  const items = Array.isArray(data?.items)?data.items:[];
  return items.map(it => it.link).filter(Boolean);
}
async function assistantSendGoogleImages(query){
  try{
    const links = await googleImageSearch(query, 6);
    const images = links.map(link => ({ name: "google", type: "image/url", dataUrl: link }));
    appendMessageTo(state.currentChatId, "assistant", `‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Google: ${query}`, images);
  }catch(e){
    appendMessageTo(state.currentChatId, "assistant", "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e?.message||e), []);
  }
}

/* ========= Themes: persistent + weather random ========= */
function setupThemeScheduler(){
  try{
    const custom = (state.settings.themeImageDataUrl||"").trim();
    if(custom){ applyThemeBackground(custom); }else{ applyThemeBackground(""); }

    if(state.weatherTimer){ clearInterval(state.weatherTimer); state.weatherTimer=null; }
    if(state.settings.enableRandomWeatherTheme==="on"){
      setRandomWeatherBackground();
      const minutes = Math.max(1, Number(state.settings.weatherRefreshMinutes||30));
      state.weatherTimer = setInterval(setRandomWeatherBackground, minutes*60000);
    }
  }catch(e){}
}
async function setRandomWeatherBackground(){
  try{
    const s=state.settings;
    if(!s.googleApiKey || !s.googleCx) return;
    const q = WEATHER_QUERIES[Math.floor(Math.random()*WEATHER_QUERIES.length)];
    const results = await googleImageSearch(q, 10);
    const imgUrl = results[Math.floor(Math.random()*results.length)];
    if(imgUrl){ el.messages.style.backgroundImage = `url('${imgUrl}')`; }
  }catch(e){}
}

/* ========= Send flow ========= */
async function onSend(){
  const text=(el.inputText.value||"").trim();
  const hasImages=Array.isArray(state.pendingImages) && state.pendingImages.length>0;
  if(!text && !hasImages) return;
  if(state.isSending) return;
  state.isSending=true; el.btnSend.disabled=true;
  state.deepThink = true;

  try{
    if(!state.currentChatId) newChat(text || (hasImages?"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°":"‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà"));

    const userImages = hasImages ? state.pendingImages.slice() : [];
    appendMessageTo(state.currentChatId, "user", text, userImages);
    state.pendingImages=[]; renderThumbs();

    const chat=loadChat(state.currentChatId);
    const reply = await callProviderForChat(chat?.messages||[]);
    appendMessageTo(state.currentChatId, "assistant", reply, []);
    persistCurrentChatMeta(state.currentChatId);

    if(/(‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ|‡∏´‡∏≤(‡∏£‡∏π‡∏õ)?|‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å google|‡∏£‡∏π‡∏õ google)/i.test(text)){
      const q = text.replace(/(‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ|‡∏´‡∏≤(‡∏£‡∏π‡∏õ)?|‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å google|‡∏£‡∏π‡∏õ google)/ig, "").trim() || "beautiful landscape";
      await assistantSendGoogleImages(q);
    }
  }catch(e){
    appendMessageTo(state.currentChatId, "assistant","‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+(e?.message||e), []);
  }finally{
    el.inputText.value="";
    el.btnSend.disabled=false;
    state.isSending=false;
  }
}

/* ========= Persistence ========= */
function persistCurrentChatMeta(chatId){
  const chat=loadChat(chatId); if(!chat) return;
  const idxItem=state.historyIndex.find(x=>x.id===chatId);
  if(idxItem){ idxItem.title=chat.title||idxItem.title; idxItem.updatedAt=chat.updatedAt||nowISO(); saveHistoryIndex(state.historyIndex); }
  saveChat(chatId,chat);
}

/* ========= Export / Clear ========= */
function exportHistory(){
  try{
    const idx=loadHistoryIndex(); const all=[];
    for(const item of idx){ const chat=loadChat(item.id); if(chat) all.push(chat); }
    const blob=new Blob([JSON.stringify({exportedAt:nowISO(),chats:all}, null, 2)], {type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a");
    a.href=url; a.download="ai-history-export.json"; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(e?.message||e)); }
}
function clearHistory(){
  if(!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
  try{
    const idx=loadHistoryIndex(); for(const item of idx){ localStorage.removeItem(chatKey(item.id)); }
    localStorage.removeItem(LS_KEYS.historyIndex);
    state.historyIndex=[]; state.currentChatId=null;
    renderHistoryIndex(); renderMessages([]);
    scheduleSync();
  }catch(e){ alert("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e)); }
}

/* ========= Google Identity Services (Popup) ========= */
let tokenClient = null;
function ensureTokenClient(){
  const clientId = state.settings.googleClientId || "";
  if(!clientId){ return null; }
  try{
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.appdata',
      prompt: 'consent',
      callback: (resp)=>{
        if(resp && resp.access_token){
          setAccessToken(resp.access_token, 3600);
          alert("‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          scheduleSync(true);
        }
      }
    });
  }catch(e){ console.warn("initTokenClient error:", e); }
  return tokenClient;
}
function openLoginModal(){
  el.googleButtonWrapper.innerHTML = "";
  el.loginBackdrop.classList.add("show");
  el.loginBackdrop.setAttribute("aria-hidden","false");
  renderGoogleSigninButton();
  ensureTokenClient();
}
function closeLoginModal(){
  el.loginBackdrop.classList.remove("show");
  el.loginBackdrop.setAttribute("aria-hidden","true");
  el.googleButtonWrapper.innerHTML = "";
}
function renderGoogleSigninButton(){
  const clientId = state.settings.googleClientId || "";
  if(!clientId){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Client ID ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"); return; }
  try{
    google.accounts.id.initialize({
      client_id: clientId,
      callback: onIdCredential,
      auto_select: false,
      ux_mode: "popup",
    });
    const host = document.createElement("div");
    el.googleButtonWrapper.appendChild(host);
    google.accounts.id.renderButton(host, {
      type: "standard",
      theme: "filled_black",
      size: "large",
      text: "signin_with",
      shape: "rectangular",
      logo_alignment: "left",
    });
  }catch(e){
    console.warn("renderButton error:", e);
  }
}
function onIdCredential(resp){
  try{
    const payload = decodeJwt(resp?.credential||"");
    if(!payload){ alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); return; }
    const user = {
      sub: payload.sub,
      name: payload.name || payload.email || "‡∏Ñ‡∏∏‡∏ì",
      email: payload.email || "",
      picture: payload.picture || "",
    };
    state.auth.user = user;
    state.auth.idToken = resp.credential;
    saveAuth(state.auth);
    showProfile(user);
    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }catch(e){
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: "+(e?.message||e));
  }
}
function requestDriveScope(){
  if(!tokenClient){ ensureTokenClient(); }
  if(!tokenClient){ alert("Token client ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Client ID"); return; }
  try{ tokenClient.requestAccessToken(); }catch(e){ alert("‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e)); }
}
function decodeJwt(jwt){
  try{ const parts = jwt.split('.'); const payload = JSON.parse(atob(parts[1])); return payload; }catch(e){ return null; }
}

/* ========= Profile UI ========= */
function showLoginButton(){
  el.loginContainer.style.display = 'block';
  el.profileContainer.style.display = 'none';
}
function showProfile(user){
  el.loginContainer.style.display = 'none';
  el.profileContainer.style.display = 'block';
  el.profileAvatar.src = user.picture || "";
  el.profileName.textContent = user.name || "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå";
}
document.addEventListener("click",(ev)=>{
  if(document.getElementById("profileContainer") && !document.getElementById("profileContainer").contains(ev.target)){
    const dd=document.getElementById("profileDropdown"); if(dd) dd.classList.remove("show");
  }
});
if(document.getElementById("btnProfile")){
  document.getElementById("btnProfile").addEventListener("click", ()=>{ const dd=document.getElementById("profileDropdown"); dd && dd.classList.toggle("show"); });
}
el.btnLogout.addEventListener("click", ()=>{
  scheduleSync(true);
  state.auth = { user:null, idToken:null, accessToken:null, accessTokenExp:0 };
  saveAuth(state.auth);
  el.profileDropdown.classList.remove("show");
  showLoginButton();
  alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
});
el.btnSyncNow.addEventListener("click", ()=> scheduleSync(true));

/* ========= Cloud Sync (Drive AppData) ========= */
function setAccessToken(accessToken, expiresIn){
  state.auth.accessToken = accessToken;
  state.auth.accessTokenExp = Date.now() + Math.max(1, Number(expiresIn||3600))*1000;
  saveAuth(state.auth);
}
async function ensureDriveFile(){
  if(!state.auth?.accessToken) return null;
  if(state.driveFileId) return state.driveFileId;
  const listRes = await fetch('https://www.googleapis.com/drive/v3/files?q=name=%27ai-chat-sync.json%27+and+mimeType=%27application/json%27+and+%27appDataFolder%27+in+parents&spaces=appDataFolder',
    { headers:{ Authorization:'Bearer '+state.auth.accessToken } });
  if(listRes.ok){
    const data = await listRes.json();
    if(Array.isArray(data.files) && data.files.length){
      const id = data.files[0].id; state.driveFileId=id; saveDriveFileId(id); return id;
    }
  }
  const meta = { name:"ai-chat-sync.json", parents:["appDataFolder"], mimeType:"application/json" };
  const boundary = 'foo_bar_baz_'+Date.now();
  const body =
    `--${boundary}\r\n`+
    'Content-Type: application/json; charset=UTF-8\r\n\r\n'+
    JSON.stringify(meta)+'\r\n'+
    `--${boundary}\r\n`+
    'Content-Type: application/json\r\n\r\n'+
    JSON.stringify(collectAllData())+'\r\n'+
    `--${boundary}--`;
  const createRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
    method:'POST',
    headers:{ Authorization:'Bearer '+state.auth.accessToken, 'Content-Type':'multipart/related; boundary='+boundary },
    body
  });
  if(!createRes.ok) return null;
  const created = await createRes.json(); const id = created.id;
  state.driveFileId=id; saveDriveFileId(id); return id;
}
async function driveUploadJson(){
  if(!state.auth?.accessToken) return false;
  const id = await ensureDriveFile(); if(!id) return false;
  const body = JSON.stringify(collectAllData());
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files/'+id+'?uploadType=media', {
    method:'PATCH',
    headers:{ Authorization:'Bearer '+state.auth.accessToken, 'Content-Type':'application/json' },
    body
  });
  return res.ok;
}
async function driveDownloadJson(){
  if(!state.auth?.accessToken) return null;
  const id = await ensureDriveFile(); if(!id) return null;
  const res = await fetch('https://www.googleapis.com/drive/v3/files/'+id+'?alt=media', {
    headers:{ Authorization:'Bearer '+state.auth.accessToken }
  });
  if(!res.ok) return null;
  return await res.json().catch(()=>null);
}
function collectAllData(){
  const idx = loadHistoryIndex();
  const all = [];
  for(const item of idx){ const chat=loadChat(item.id); if(chat) all.push(chat); }
  return {
    savedAt: nowISO(),
    uiLanguage: state.settings.uiLanguage,
    settings: state.settings,
    historyIndex: idx,
    chats: all
  };
}
function restoreFromData(data){
  try{
    if(!data) return;
    if(data.settings){ state.settings = { ...defaultSettings, ...(data.settings||{}) }; saveSettings(state.settings); }
    if(Array.isArray(data.historyIndex)){
      const oldIdx = loadHistoryIndex();
      for(const item of oldIdx){ localStorage.removeItem(chatKey(item.id)); }
      saveHistoryIndex(data.historyIndex||[]);
      const chats = Array.isArray(data.chats)?data.chats:[];
      for(const c of chats){ saveChat(c.id, c); }
      state.historyIndex = loadHistoryIndex();
    }
    applyI18n();
    setupThemeScheduler();
    renderHistoryIndex();
    if(state.historyIndex.length){
      const latest=state.historyIndex.slice().sort((a,b)=> new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt))[0];
      state.currentChatId=latest.id;
      const chat=loadChat(latest.id);
      renderMessages(chat?.messages||[]);
    }
  }catch(e){}
}
function scheduleSync(force=false){
  if(!state.auth?.user) return;
  if(force){ doSync(); return; }
  if(state.syncScheduled) return;
  state.syncScheduled = true;
  setTimeout(()=>{ state.syncScheduled=false; doSync(); }, 1200);
}
async function doSync(){
  try{
    if(!state.auth?.accessToken || Date.now() >= (state.auth.accessTokenExp||0)){
      console.warn("‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î ‚Äò‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive‚Äô ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏¢‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      return;
    }
    await driveUploadJson();
  }catch(e){}
}

/* ========= Mobile sidebar & global UI ========= */
function isMobile(){
  return window.matchMedia("(max-width: 900px)").matches;
}
function openMobileSidebar(){
  if(!isMobile()) return;
  el.sidebar.classList.add("show");
  el.mobileOverlay.classList.add("show");
  el.mobileOverlay.setAttribute("aria-hidden","false");
}
function closeMobileSidebar(){
  if(!isMobile()) return;
  el.sidebar.classList.remove("show");
  el.mobileOverlay.classList.remove("show");
  el.mobileOverlay.setAttribute("aria-hidden","true");
}

/* ========= Events (bound on DOMContentLoaded to avoid first-click miss) ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  // i18n initial
  state.settings=loadSettings();
  applyI18n();

  // Settings button ‚Äî bind reliably on first paint
  el.btnSettings?.addEventListener("click", openSettings);
  el.btnCloseSettings?.addEventListener("click", closeSettings);
  el.btnSaveSettings?.addEventListener("click", saveSettingsFromModal);
  el.btnResetSettings?.addEventListener("click", resetSettings);
  el.btnTest?.addEventListener("click", async ()=>{
    try{
      const reply = await callProviderForChat([{ role:"user", content:[{type:"text", text:"‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô: ‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤ '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'"}] }]);
      alert("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ä‡∏ó‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+reply);
    }catch(e){
      alert("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ä‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e));
    }
  });

  // Chat actions
  el.btnSend?.addEventListener("click", onSend);
  el.inputText?.addEventListener("keydown",(ev)=>{ if(ev.key==="Enter" && !ev.shiftKey){ ev.preventDefault(); onSend(); } });
  el.btnPickImage?.addEventListener("click", ()=> el.fileInput.click());
  el.fileInput?.addEventListener("change",(ev)=> addFiles(ev.target.files));
  document.addEventListener("paste",(ev)=>{
    const items = ev.clipboardData?.items || [];
    const files = [];
    for(const it of items){ if(it.kind==="file" && it.type.startsWith("image/")){ const file = it.getAsFile(); if(file) files.push(file); } }
    if(files.length) addFiles(files);
  });

  // Sidebar
  el.btnToggleSidebar?.addEventListener("click", ()=>{
    if(!isMobile()) return;
    const showing = el.sidebar.classList.contains("show");
    if(showing) closeMobileSidebar(); else openMobileSidebar();
  });
  el.mobileOverlay?.addEventListener("click", closeMobileSidebar);

  // Export/Clear/New
  el.btnNewChat?.addEventListener("click", ()=> { newChat("‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà"); closeMobileSidebar(); });
  el.btnExport?.addEventListener("click", exportHistory);
  el.btnClearHistory?.addEventListener("click", clearHistory);

  // Login modal
  el.btnGoogleLogin?.addEventListener("click", openLoginModal);
  el.btnCloseLogin?.addEventListener("click", closeLoginModal);
  el.btnLoginDone?.addEventListener("click", closeLoginModal);
  el.btnGrantDrive?.addEventListener("click", requestDriveScope);
  el.btnRestoreCloud?.addEventListener("click", async ()=>{
    try{
      if(!state.auth?.accessToken){ alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive ‚Äî ‡∏Å‡∏î ‚Äò‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Drive‚Äô ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏¢‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô"); return; }
      const data = await driveDownloadJson();
      restoreFromData(data);
    }catch(e){ alert("‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+(e?.message||e)); }
  });

  // Escape to close overlays
  document.addEventListener("keydown",(ev)=>{ if(ev.key==="Escape") { closeLoginModal(); closeSettings(); closeMobileSidebar(); } });

  // Profile / Login initial
  if(state.auth?.user){ showProfile(state.auth.user); } else { showLoginButton(); }

  // Themes
  setupThemeScheduler();

  // History & chat
  const idx=loadHistoryIndex(); state.historyIndex=Array.isArray(idx)?idx:[];
  renderHistoryIndex();
  if(state.historyIndex.length>0){
    const latest=state.historyIndex.slice().sort((a,b)=> new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt))[0];
    state.currentChatId=latest.id;
    const chat=loadChat(latest.id);
    renderMessages(chat?.messages||[]);
  }else{
    newChat("");
  }

  // Fix: ensure settings modal can open on first click even if CSS didn't compute yet
  // Pre-prime display state so show class works immediately
  if(el.settingsBackdrop){
    el.settingsBackdrop.style.display = "none";
    el.settingsBackdrop.classList.remove("show");
    el.settingsBackdrop.setAttribute("aria-hidden","true");
  }
});
</script>
</body>
</html>